{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://eleanorproject.org/schemas/evidence_bundle.json",
  "title": "Evidence Bundle",
  "description": "Atomic unit of reasoning across critics containing evaluation evidence, metadata, and context",
  "type": "object",
  "required": [
    "bundle_id",
    "version",
    "timestamp",
    "input_snapshot",
    "critic_outputs",
    "metadata"
  ],
  "properties": {
    "bundle_id": {
      "type": "string",
      "description": "Unique identifier for this evidence bundle",
      "format": "uuid"
    },
    "version": {
      "type": "string",
      "description": "Schema version tag for compatibility tracking",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "default": "1.0.0"
    },
    "timestamp": {
      "type": "string",
      "description": "ISO 8601 timestamp when evidence bundle was created",
      "format": "date-time"
    },
    "input_snapshot": {
      "type": "object",
      "description": "Snapshot of the input context at evaluation time",
      "required": ["text", "context_hash"],
      "properties": {
        "text": {
          "type": "string",
          "description": "Primary text content being evaluated",
          "minLength": 1
        },
        "context": {
          "type": "object",
          "description": "Additional contextual information",
          "additionalProperties": true
        },
        "metadata": {
          "type": "object",
          "description": "Input-level metadata",
          "properties": {
            "source": {
              "type": "string",
              "description": "Origin of the input"
            },
            "domain": {
              "type": "string",
              "description": "Domain category (e.g., healthcare, finance)"
            },
            "tags": {
              "type": "array",
              "items": {"type": "string"},
              "description": "Classification tags"
            }
          }
        },
        "context_hash": {
          "type": "string",
          "description": "SHA-256 hash of input for deduplication and similarity matching",
          "pattern": "^[a-f0-9]{64}$"
        }
      }
    },
    "critic_outputs": {
      "type": "array",
      "description": "Array of individual critic evaluation outputs",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["critic", "verdict", "confidence", "justification", "timestamp"],
        "properties": {
          "critic": {
            "type": "string",
            "description": "Name/identifier of the critic that produced this output",
            "minLength": 1
          },
          "verdict": {
            "type": "string",
            "description": "Critic's evaluation verdict",
            "enum": ["ALLOW", "DENY", "REVIEW", "ERROR", "ABSTAIN"]
          },
          "confidence": {
            "type": "number",
            "description": "Confidence level of the verdict (0.0 to 1.0)",
            "minimum": 0.0,
            "maximum": 1.0
          },
          "justification": {
            "type": "string",
            "description": "Detailed explanation for the verdict",
            "minLength": 1
          },
          "weight": {
            "type": "number",
            "description": "Weight assigned to this critic in aggregation",
            "minimum": 0.0,
            "default": 1.0
          },
          "priority": {
            "type": ["string", "null"],
            "description": "Priority level for override/veto capabilities",
            "enum": ["override", "veto", null]
          },
          "timestamp": {
            "type": "string",
            "description": "ISO 8601 timestamp of critic evaluation",
            "format": "date-time"
          },
          "config_version": {
            "type": "string",
            "description": "Version of critic configuration used",
            "pattern": "^\\d+\\.\\d+\\.\\d+$"
          },
          "evidence_sources": {
            "type": "array",
            "description": "References to evidence sources used by critic",
            "items": {
              "type": "object",
              "properties": {
                "type": {
                  "type": "string",
                  "enum": ["policy", "precedent", "rule", "constitutional_principle"]
                },
                "reference": {
                  "type": "string",
                  "description": "Identifier or citation of the evidence source"
                },
                "relevance_score": {
                  "type": "number",
                  "minimum": 0.0,
                  "maximum": 1.0
                }
              }
            }
          }
        }
      }
    },
    "justification_synthesis": {
      "type": "object",
      "description": "Aggregated justification structure combining critic outputs",
      "properties": {
        "summary": {
          "type": "string",
          "description": "High-level summary of all critic justifications"
        },
        "supporting_evidence": {
          "type": "array",
          "description": "Key supporting evidence points",
          "items": {"type": "string"}
        },
        "conflicting_evidence": {
          "type": "array",
          "description": "Points of conflict or disagreement between critics",
          "items": {
            "type": "object",
            "properties": {
              "critics": {
                "type": "array",
                "items": {"type": "string"}
              },
              "description": {"type": "string"}
            }
          }
        },
        "confidence_assessment": {
          "type": "object",
          "description": "Overall confidence metrics",
          "properties": {
            "average_confidence": {
              "type": "number",
              "minimum": 0.0,
              "maximum": 1.0
            },
            "confidence_variance": {
              "type": "number",
              "minimum": 0.0
            },
            "consensus_level": {
              "type": "string",
              "enum": ["unanimous", "strong", "moderate", "weak", "conflicted"]
            }
          }
        }
      }
    },
    "metadata": {
      "type": "object",
      "description": "Evidence bundle metadata for tracking and auditing",
      "required": ["created_at", "system_version"],
      "properties": {
        "created_at": {
          "type": "string",
          "description": "ISO 8601 timestamp of bundle creation",
          "format": "date-time"
        },
        "updated_at": {
          "type": "string",
          "description": "ISO 8601 timestamp of last update",
          "format": "date-time"
        },
        "system_version": {
          "type": "string",
          "description": "Version of the EJE system that created this bundle",
          "pattern": "^\\d+\\.\\d+\\.\\d+$"
        },
        "critic_config_versions": {
          "type": "object",
          "description": "Map of critic names to their configuration versions",
          "additionalProperties": {"type": "string"}
        },
        "processing_time_ms": {
          "type": "number",
          "description": "Total processing time in milliseconds",
          "minimum": 0
        },
        "environment": {
          "type": "string",
          "description": "Environment where bundle was created",
          "enum": ["production", "staging", "development", "test"]
        },
        "correlation_id": {
          "type": "string",
          "description": "Correlation ID for distributed tracing"
        },
        "precedent_refs": {
          "type": "array",
          "description": "References to similar precedent cases consulted",
          "items": {
            "type": "object",
            "properties": {
              "precedent_id": {"type": "string"},
              "similarity_score": {
                "type": "number",
                "minimum": 0.0,
                "maximum": 1.0
              },
              "influence_weight": {
                "type": "number",
                "minimum": 0.0,
                "maximum": 1.0
              }
            }
          }
        },
        "flags": {
          "type": "object",
          "description": "Operational flags and markers",
          "properties": {
            "requires_human_review": {"type": "boolean"},
            "is_override": {"type": "boolean"},
            "is_fallback": {"type": "boolean"},
            "is_test": {"type": "boolean"}
          }
        }
      }
    },
    "validation_errors": {
      "type": "array",
      "description": "Any validation errors encountered during bundle creation",
      "items": {
        "type": "object",
        "properties": {
          "field": {"type": "string"},
          "error": {"type": "string"},
          "severity": {
            "type": "string",
            "enum": ["error", "warning", "info"]
          }
        }
      }
    }
  }
}
